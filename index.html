<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<title>OXRS Admin</title>

	<link href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">

	<script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
	<script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
	<script src="https://unpkg.com/@rjsf/core/dist/react-jsonschema-form.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

	<style>
		.container { margin-top: 2rem; margin-bottom: 2rem; }
	</style>

	<script>

	const addr_form = JSONSchemaForm.default;
	const fw_form = JSONSchemaForm.default;
	const mqtt_form = JSONSchemaForm.default;
	const conf_form = JSONSchemaForm.default;
	const cmnd_form = JSONSchemaForm.default;

	/* JSON schema for initial address page */
	const addressSchema = {
		"$schema": "http://json-schema.org/draft-07/schema#",
		"title": "OXRS Admin",
		"type": "object",
		"properties": {
			"address": {
				"type": "string",
				"title": "Device Address",
				"description": "IP address or hostname of your OXRS device"
			},
			"action": {
				"enum": [ "mqtt", "config", "command", "firmware" ],
				"enumNames": [ "Setup MQTT", "Edit Config", "Send Command", "View Firmware" ],
				"title": "Action",
				"description": "Administrative action to perform on your OXRS device"
			}
		},
		"required": [
			"address",
			"action"
		]
	};

	const addressUiSchema = {
		"address": {
			"ui:placeholder": "192.168.1.123 or oxrs.local",
			"ui:autofocus": true
		}
	};

	/* JSON data for initial address page - default to 'Setup MQTT' */
	const addressData = {
		"action": "mqtt"
	};


	/* JSON schema for MQTT setup page */
	const mqttSchema = {
		"$schema": "http://json-schema.org/draft-07/schema#",
		"title": "OXRS MQTT",
		"type": "object",
		"properties": {
			"broker": {
				"type": "string",
				"title": "Broker Address"
			},
			"port": {
				"type": "integer",
				"title": "Broker Port"
			},
			"clientId": {
				"type": "string",
				"title": "Client ID"
			},
			"username": {
				"type": "string",
				"title": "Username"
			},
			"password": {
				"type": "string",
				"title": "Password"
			},
			"topicPrefix": {
				"type": "string",
				"title": "Topic Prefix"
			},
			"topicSuffix": {
				"type": "string",
				"title": "Topic Suffix"
			}
		},
		"required": [
			"broker",
			"clientId"
		]
	};

	const mqttUiSchema = {
		"broker": {
			"ui:placeholder": "192.168.1.123 or mqtt.local",
			"ui:autofocus": true
		},
		"port": {
			"ui:placeholder": "1883"
		},
		"password": {
			"ui:widget": "password"
		}
	};


	/* JSON schema for firmware page */
	const firmwareSchema = {
		"$schema": "http://json-schema.org/draft-07/schema#",
		"title": "OXRS Firmware",
		"type": "object",
		"properties": {
			"name": {
				"type": "string",
				"title": "Name"
			},
			"shortName": {
				"type": "string",
				"title": "Short Name"
			},
			"maker": {
				"type": "string",
				"title": "Maker"
			},
			"version": {
				"type": "string",
				"title": "Version"
			}
		}
	};

	const firmwareUiSchema = {
    "ui:readonly": true
	};


	/**
	 * Loads MQTT config form
	 *
	 * @param {string} device_address Device address (IP or hostname)
	 * @returns {void}
	 */
	function loadMqttForm(device_address)
	{
		$.when(getApi(device_address, "mqtt"))
			.done(function(data, statusText, jqXHR)
			{
				// Hide other forms
				$('#addr_form').hide('fast');
				$('#fw_form').hide('fast');
				$('#cmnd_form').hide('fast');
				$('#conf_form').hide('fast');
        
				var mqttData = data;
        
				// Render MQTT form
				ReactDOM.render( /*#__PURE__*/
				React.createElement(mqtt_form,
				{
					schema: mqttSchema,
					uiSchema: mqttUiSchema,
					validate: mqttValidate,
					formData: mqttData,
					onSubmit: function(data)
					{
						postApi(device_address, "mqtt", data.formData);
					}
				}),
				document.getElementById("mqtt_form"));
			})
			.fail(function()
			{
				alert(`Failed to load MQTT action`);
			});
	}

	/**
	 * Validate MQTT config form
	 */
	function mqttValidate(formData, errors)
	{
		if (formData.username && !formData.password)
		{
			errors.password.addError("Password is mandatory if username specified");
		}

		return errors;
	}


	/**
	 * Loads firmware config form
	 *
	 * @param {string} device_address Device address (IP or hostname)
	 * @returns {void}
	 */
	function loadConfigForm(device_address)
	{
		$.when(getApi(device_address, "adopt"), getApi(device_address, "config"))
			.done(function(adopt, config)
			{
				// Hide other forms
				$('#addr_form').hide('fast');
				$('#fw_form').hide('fast');
				$('#mqtt_form').hide('fast');
				$('#cmnd_form').hide('fast');
        
				var configSchema = adopt[0].configSchema;
				var configData = config[0];

				// Render config form
				ReactDOM.render( /*#__PURE__*/
				React.createElement(conf_form,
				{
					schema: configSchema,
					formData: configData,
					onSubmit: function(data)
					{
						postApi(device_address, "config", data.formData);
					}
				}),
				document.getElementById("conf_form"));
			})
			.fail(function()
			{
				alert(`Failed to load config action`);
			});
	}


	/**
	 * Loads firmware command form
	 *
	 * @param {string} device_address Device address (IP or hostname)
	 * @returns {void}
	 */
	function loadCommandForm(device_address)
	{
		$.when(getApi(device_address, "adopt"))
			.done(function(data, statusText, jqXHR)
			{
				// Hide other forms
				$('#addr_form').hide('fast');
				$('#fw_form').hide('fast');
				$('#mqtt_form').hide('fast');
				$('#conf_form').hide('fast');
        
				var commandSchema = data.commandSchema;

				// Render command form
				ReactDOM.render( /*#__PURE__*/
				React.createElement(cmnd_form,
				{
					schema: commandSchema,
					onSubmit: function(data)
					{
						postApi(device_address, "command", data.formData);
					}
				}),
				document.getElementById("cmnd_form"));
			})
			.fail(function()
			{
				alert(`Failed to load command action`);
			});
	}


	/**
	 * Loads firmware form
	 *
	 * @param {string} device_address Device address (IP or hostname)
	 * @returns {void}
	 */
	function loadFirmwareForm(device_address)
	{
		$.when(getApi(device_address, "adopt"))
			.done(function(data, statusText, jqXHR)
			{
				// Hide other forms
				$('#addr_form').hide('fast');
				$('#mqtt_form').hide('fast');
				$('#cmnd_form').hide('fast');
				$('#conf_form').hide('fast');
        
				var firmwareData = data.firmware;

				// Render firmware form
				ReactDOM.render( /*#__PURE__*/
				React.createElement(fw_form,
				{
					schema: firmwareSchema,
					uiSchema: firmwareUiSchema,
					formData: firmwareData,
				}),
				document.getElementById("fw_form"));
			})
			.fail(function()
			{
				alert(`Failed to load firmware action`);
			});
	}


	/**
	 * Create API GET request
	 *
	 * @param {string} device_address Device IP address
	 * @param {string} endpoint API endpoint
	 * @returns {Promise} A promise to the AJAX request
	 */
	function getApi(device_address, endpoint)
	{
		return $.ajax({
			url: `http://${device_address}/api/${endpoint}`,
			method: 'GET',
			dataType: 'json',
			crossDomain: true
		});
	}


	/**
	 * Create API POST request
	 *
	 * @param {string} device_address Device IP address
	 * @param {string} endpoint API endpoint
	 * @param {json} data API payload
	 * @returns {void}
	 */
	function postApi(device_address, endpoint, data)
	{
		$.ajax({
			url: `http://${device_address}/api/${endpoint}`,
			method: 'POST',
			crossDomain: true,
			data: JSON.stringify(data),
			statusCode:
			{
				404: function() { alert("Error: Device not found"); },
				204: function() { alert("Success!"); },
			},
			error: function(xhr, status, error)
			{
				alert(error || 'Unknown error');
			}
		});
	}


	/**
	 * Main program: loads inital device address form
	 * Called once all elements are ready/loaded
	 *
	 * @returns {void}
	 */
	$(document).ready(function()
	{
		// Render device address form
		ReactDOM.render( /*#__PURE__*/
			React.createElement(addr_form,
			{
				schema: addressSchema,
				uiSchema: addressUiSchema,
				formData: addressData,
				onSubmit: function(data)
				{
					// Load the form for the selected action
					if (data.formData.action === "mqtt") {
						loadMqttForm(data.formData.address);
					} else if (data.formData.action === "config") {
						loadConfigForm(data.formData.address);
					} else if (data.formData.action === "command") {
						loadCommandForm(data.formData.address);
					} else if (data.formData.action === "firmware") {
						loadFirmwareForm(data.formData.address);
					} else {
						alert(`Unsupported action: ${data.formData.action}`);
					}
				}
			}),
			document.getElementById("addr_form")
		);
	});
	</script>

</head>

<body>
	<div class="container">
		<div id="addr_form"></div>
	</div>
	<div class="container">
		<div id="mqtt_form"></div>
	</div>
	<div class="container">
		<div id="conf_form"></div>
	</div>
	<div class="container">
		<div id="cmnd_form"></div>
	</div>
	<div class="container">
		<div id="fw_form"></div>
	</div>
</body>

</html>
